name: PCM CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # ====================================================
  # Lean 定理验证
  # ====================================================
  lean-proofs:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Install elan (Lean version manager)
        run: |
          curl -sSf https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh \
            | sh -s -- -y --no-modify-path
          echo "$HOME/.elan/bin" >> "$GITHUB_PATH"
      - name: Install Lean toolchain
        run: |
          cd lean
          elan toolchain install "$(cat lean-toolchain)"
          elan override set "$(cat lean-toolchain)"
      - name: Cache Lake packages
        uses: actions/cache@v4
        with:
          path: lean/.lake
          key: lake-${{ runner.os }}-${{ hashFiles('lean/lean-toolchain', 'lean/lake-manifest.json') }}
          restore-keys: lake-${{ runner.os }}-
      - name: Build Lean specs and proofs
        run: |
          cd lean
          lake build PCM
      - name: Verify soundness theorems
        run: |
          cd lean
          lake build PCMProofs

  # ====================================================
  # Rust 检查与测试
  # ====================================================
  rust-check:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y libclang-dev librocksdb-dev protobuf-compiler
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
      - name: Format check
        run: cargo fmt --all -- --check
      - name: Clippy
        run: cargo clippy --workspace -- -D warnings
      - name: Tests
        run: cargo test --workspace

  # ====================================================
  # Performance benchmark
  # ====================================================
  performance:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: read
    env:
      PCM_BENCH_SAMPLE_SIZE: "20"
      PCM_BENCH_WARMUP_MS: "50"
      PCM_BENCH_MEASURE_MS: "10"
    steps:
      - uses: actions/checkout@v4
      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y libclang-dev librocksdb-dev protobuf-compiler
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Run performance benchmark
        run: cargo bench -p pcm-monitor-gateway --bench evaluate_bench
      - name: Benchmark report
        run: bash scripts/bench-report.sh

  # ====================================================
  # Lean FFI 对拍测试
  # ====================================================
  lean-ffi-tests:
    needs: [lean-proofs]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y libclang-dev librocksdb-dev protobuf-compiler
      - name: Install elan (Lean version manager)
        run: |
          curl -sSf https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh \
            | sh -s -- -y --no-modify-path
          echo "$HOME/.elan/bin" >> "$GITHUB_PATH"
      - name: Install Lean toolchain
        run: |
          cd lean
          elan toolchain install "$(cat lean-toolchain)"
          elan override set "$(cat lean-toolchain)"
      - name: Cache Lake packages
        uses: actions/cache@v4
        with:
          path: lean/.lake
          key: lake-${{ runner.os }}-${{ hashFiles('lean/lean-toolchain', 'lean/lake-manifest.json') }}
          restore-keys: lake-${{ runner.os }}-
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Build pcm_checker
        run: |
          cd lean
          lake build pcm_checker
      - name: Run Lean FFI integration tests
        run: cargo test -p pcm-cert-checker-ffi --test lean_integration -- --ignored
        env:
          PCM_CHECKER_BIN: ${{ github.workspace }}/lean/.lake/build/bin/pcm_checker

  # ====================================================
  # 安全扫描
  # ====================================================
  security:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install cargo-audit
        run: cargo install cargo-audit --locked
      - name: Audit dependencies
        run: cargo audit
      - name: Trivy filesystem scan
        if: always()
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          severity: HIGH,CRITICAL
          format: sarif
          output: trivy-results.sarif
      - name: Upload Trivy SARIF results
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('trivy-results.sarif') != ''
        with:
          sarif_file: trivy-results.sarif

  # ====================================================
  # 集成测试
  # ====================================================
  integration-push:
    if: github.event_name == 'push'
    needs: [rust-check, lean-proofs, lean-ffi-tests]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y libclang-dev librocksdb-dev protobuf-compiler
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Start Postgres
        run: docker compose -f docker-compose.yml up -d postgres
      - name: Wait for Postgres to be ready
        run: |
          for i in $(seq 1 15); do
            docker compose exec -T postgres pg_isready -U pcm && break
            echo "Waiting for postgres... ($i/15)"
            sleep 2
          done
      - name: Run integration tests
        run: cargo test --workspace --exclude pcm-cert-checker-ffi -- --ignored
        env:
          DATABASE_URL: postgres://pcm:pcm@localhost:5432/pcm_policies

  integration-pr:
    if: github.event_name == 'pull_request'
    needs: [rust-check, lean-proofs, lean-ffi-tests, performance]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y libclang-dev librocksdb-dev protobuf-compiler
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Start Postgres
        run: docker compose -f docker-compose.yml up -d postgres
      - name: Wait for Postgres to be ready
        run: |
          for i in $(seq 1 15); do
            docker compose exec -T postgres pg_isready -U pcm && break
            echo "Waiting for postgres... ($i/15)"
            sleep 2
          done
      - name: Run integration tests
        run: cargo test --workspace --exclude pcm-cert-checker-ffi -- --ignored
        env:
          DATABASE_URL: postgres://pcm:pcm@localhost:5432/pcm_policies

  # ====================================================
  # 策略 Diff 分析（仅 PR）
  # ====================================================
  policy-diff:
    if: github.event_name == 'pull_request'
    needs: [rust-check]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y libclang-dev librocksdb-dev protobuf-compiler
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Build CLI
        run: cargo build --release --package pcm-cli
      - name: Check for policy changes
        id: policy-check
        run: |
          if git diff --name-only origin/main...HEAD | grep -q '^policies/'; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Run diff analysis
        if: steps.policy-check.outputs.changed == 'true'
        run: |
          echo "Policy diff analysis would run here"
          # ./target/release/pcm diff --old main --new HEAD --output report.json
          # ./target/release/pcm verify report.json
