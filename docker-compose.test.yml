# Docker Compose 配置 — CI 集成测试用
# 用法：docker compose -f docker-compose.test.yml up --build --abort-on-container-exit --exit-code-from test-runner

services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: pcm
      POSTGRES_PASSWORD: pcm
      POSTGRES_DB: pcm
    volumes:
      - ./docker/init-db.sh:/docker-entrypoint-initdb.d/01-init-db.sh
      - ./docker/init-db.sql:/docker-entrypoint-initdb.d/02-init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pcm"]
      interval: 5s
      timeout: 3s
      retries: 5
    tmpfs:
      - /var/lib/postgresql/data

  # ── 策略服务 ──
  policy-service:
    build:
      context: .
      dockerfile: docker/policy-service.Dockerfile
    environment:
      RUST_LOG: pcm=debug,info
      DATABASE_URL: postgres://pcm:pcm@postgres:5432/pcm
      PCM_POLICY_PORT: "50052"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/50052' || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 30s

  # ── 图服务 ──
  graph-service:
    build:
      context: .
      dockerfile: docker/graph-service.Dockerfile
    environment:
      RUST_LOG: pcm=debug,info
      PCM_GRAPH_PORT: "50053"
      PCM_GRAPH_DATA_DIR: /data/graph
    tmpfs:
      - /data/graph
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/50053' || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 30s

  # ── 审计服务 ──
  audit-service:
    build:
      context: .
      dockerfile: docker/audit-service.Dockerfile
    environment:
      RUST_LOG: pcm=debug,info
      DATABASE_URL: postgres://pcm:pcm@postgres:5432/pcm
      PCM_AUDIT_PORT: "50054"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/50054' || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 30s

  # ── 监控器网关 ──
  monitor-gateway:
    build:
      context: .
      dockerfile: docker/monitor-gateway.Dockerfile
    environment:
      RUST_LOG: pcm=debug,info
      PCM_GATEWAY_PORT: "50051"
      PCM_GRAPH_ENDPOINT: http://graph-service:50053
      PCM_POLICY_FILE: /policies/default.pcm
      PCM_AUDIT_ENDPOINT: http://audit-service:50054
    volumes:
      - ./policies:/policies:ro
    depends_on:
      graph-service:
        condition: service_healthy
      audit-service:
        condition: service_healthy
      policy-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/50051' || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 30s

  # ── E2E 测试运行器 ──
  test-runner:
    build:
      context: .
      dockerfile: docker/test-runner.Dockerfile
    environment:
      - DATABASE_URL=postgres://pcm:pcm@postgres:5432/pcm
      - PCM_MONITOR_ENDPOINT=http://monitor-gateway:50051
      - PCM_POLICY_ENDPOINT=http://policy-service:50052
      - PCM_GRAPH_ENDPOINT=http://graph-service:50053
      - PCM_AUDIT_ENDPOINT=http://audit-service:50054
      - RUST_LOG=pcm_e2e=debug,info
    depends_on:
      monitor-gateway:
        condition: service_healthy
    command: ["cargo", "test", "-p", "pcm-e2e-tests", "--test", "e2e", "--", "--test-threads=1"]
